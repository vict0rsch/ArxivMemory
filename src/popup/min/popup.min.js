const handleBackToFocus=e=>{const t=eventId(e);setTimeout(()=>{dispatch("memory-container--"+t,"focus")},250)},handleDeleteItem=e=>{e=eventId(e);showConfirmDeleteModal(e)},handleOpenItemLink=e=>{e=eventId(e);focusExistingOrCreateNewPaperTab(global.state.papers[e],!0)},handleOpenItemCodeLink=e=>{e=eventId(e),e=global.state.papers[e].codeLink;focusExistingOrCreateNewCodeTab(e)},handleCopyMarkdownLink=async e=>{var e=eventId(e),t=global.state.prefs,a=t.checkPreferPdf?"PDF":"Abstract",o=global.state.papers[e],o=makeMdLink(o,t);copyAndConfirmMemoryItem(e,o,`Markdown ${a} link copied!`)},handleCopyBibtex=e=>{var e=eventId(e),t=global.state.papers[e].bibtex;copyAndConfirmMemoryItem(e,bibtexToString(t),"Bibtex copied!")},handleCopyPDFLink=async e=>{var e=eventId(e),t=global.state.prefs,a=global.state.papers[e],a=(t.checkPreferPdf?paperToPDF:paperToAbs)(a),t=t.checkPreferPdf?"PDF":"Abstract";copyAndConfirmMemoryItem(e,a,t+" link copied!")},handleAddItemToFavorites=e=>{var e=eventId(e),t=hasClass("memory-container--"+e,"favorite");saveFavoriteItem(e,!t)},handleMemoryOpenLocal=e=>{e=eventId(e),e=global.state.files[e];e&&(e.id||0===e.id)&&chrome.downloads.open(e.id)},handleTextareaFocus=()=>{textareaFocusEnd(this)},handleMemorySaveEdits=async e=>{var{note:t,codeLink:a}=getPaperEdits(e);saveNote(e,t),saveCodeLink(e,a),updatePaperTags(e,"memory-item-tags"),await setStorage("syncPush",!0)},handleCancelPaperEdit=e=>{e.preventDefault();var e=eventId(e),t=global.state.papers[e];val(findEl(e,"form-note-textarea"),t.note),setHTML(findEl(e,"memory-item-tags"),getTagsOptions(t)),dispatch(findEl(e,"memory-item-edit"),"click")},handleTogglePaperEdit=e=>{e.preventDefault();e=eventId(e);const t=findEl("memory-container--"+e);var a=findEl(e,"code-and-note"),o=findEl(e,"extended-item"),s=findEl(e,"tag-list"),r=findEl(e,"memory-authors"),i=findEl(e,"edit-tags"),l=findEl(e,"memory-item-actions");const n=$(findEl(e,"memory-item-tags"));hasClass(t,"expand-open")?(removeClass(t,"expand-open"),slideDown(a,150),slideDown(s,150),slideDown(l,150),slideDown(r,150),slideUp(o,150),slideUp(i,150),setTimeout(()=>{n.select2("destroy")},500)):(addClass(t,"expand-open"),n.select2({...global.select2Options,width:"86%"}),hasClass(t,"has-monitoring")||n.on("change",monitorPaperEdits(e,!1)),t.classList.add("has-monitoring"),slideUp(a,150),slideUp(s,150),slideUp(l,150),slideUp(r,150),slideDown(o,150),slideDown(i,150))},handleMemorySelectChange=e=>{e=e.target.value;global.state.sortKey=e,sortMemory(),displayMemoryTable(),setMemorySortArrow("down")},handleMemorySortArrow=e=>{"memory-sort-arrow-down"===document.querySelector("#memory-sort-arrow svg").id?setMemorySortArrow("up"):setMemorySortArrow("down"),reverseMemory(),displayMemoryTable()},handleFilterFavorites=()=>{var e=!global.state.showFavorites;(global.state.showFavorites=e)?(addClass(findEl("filter-favorites").querySelector("svg"),"favorite"),sortMemory(),global.state.papersList=global.state.papersList.filter(e=>e.favorite),displayMemoryTable(),setMemorySortArrow("down"),findEl("memory-select").innerHTML+='<option value="favoriteDate">Last favoured</option>',e=global.state.papersList.length,setPlaceholder("memory-search",`Search ${e} entries...`)):(removeClass(findEl("filter-favorites").querySelector("svg"),"favorite"),"favoriteDate"===val("memory-select")&&(val("memory-select","lastOpenDate"),global.state.sortKey="lastOpenDate"),document.querySelector('#memory-select option[value="favoriteDate"]').remove(),sortMemory(),setMemorySortArrow("down"),val("memory-search").trim()?dispatch("memory-search","keypress"):(global.state.papersList=global.state.sortedPapers,displayMemoryTable()),e=global.state.sortedPapers.length,setPlaceholder("memory-search",`Search ${e} entries...`))},handleMemorySearchKeyPress=a=>e=>{const t=val("memory-search").trim();if(log(t),t||setTimeout(()=>{style("memory-search-clear-icon","visibility","hidden")},0),!t){if(global.state.papersList.length!==global.state.sortedPapers.length)return global.state.papersList=global.state.sortedPapers,void displayMemoryTable();if(!a&&"Backspace"!==e.key)return}style("memory-search-clear-icon","visibility","visible"),(t.startsWith("t:")?searchMemoryByTags:t.startsWith("c:")?searchMemoryByCode:t.startsWith("y:")?searchMemoryByYear:searchMemory)(t),displayMemoryTable()},handleMemorySearchKeyUp=e=>{var t;"Backspace"==e.key&&((t=new Event("keypress")).key="Backspace",dispatch("memory-search",t)),"memory-search"===e.target.id&&dispatch("memory-search","keypress")},handleCancelModalClick=()=>{hideId("delete-paper-modal")},handleConfirmDeleteModalClick=async e=>{var t=findEl("delete-paper-modal-hidden-id").innerHTML,a=global.state.papers[t].title,o=global.state.papers[t].pdfLink;await deletePaperInStorage(t,global.state.papers),displayMemoryTable(),hideId("delete-paper-modal"),info(`Successfully deleted "${a}" (${t}) from PaperMemory`),global.state.currentId===t&&await updatePopupPaperNoMemory(o),setPlaceholder("memory-search",`Search ${global.state.papersList.length} entries ...`),addListener("memory-switch","click",handleMemorySwitchClick)},handleTagClick=e=>{e=e.target.textContent;val("memory-search","t: "+e),dispatch("memory-search","keypress")},handleClearSearch=e=>{val("memory-search",""),dispatch("memory-search","clear-search"),style("memory-search-clear-icon","visibility","hidden")},handleMemorySwitchClick=()=>{(global.state.memoryIsOpen?closeMemory:openMemory)()},handlePopupKeydown=t=>{var a=t.key;if(!(["Backspace","Enter","Escape","a","e"].indexOf(a)<0))if(global.state.prefsIsOpen)"Escape"===a?(t.preventDefault(),closeMenu()):"Enter"===a&&document.querySelector("#menu-switch:focus")&&closeMenu();else if(global.state.memoryIsOpen){if("Enter"===a){if(document.querySelector("#filter-favorites:focus"))return void dispatch("filter-favorites","click");if(document.querySelector("#memory-sort-arrow:focus")&&"Enter"===a)return void dispatch("memory-sort-arrow","click")}let e;const o=document.querySelector(".memory-container:focus");if("Escape"!==a){if(!o)return;e=o.id.split("--")[1]}"Backspace"===a?dispatch(findEl(e,"memory-delete"),"click"):"Enter"===a?dispatch(findEl(e,"memory-item-link"),"click"):"Escape"===a?(t.preventDefault(),o&&hasClass(o,"expand-open")?handleTogglePaperEdit(t):closeMemory()):"e"===a&&dispatch(findEl(e,"memory-item-edit"),"click")}else if("a"===a){const e=queryAll(document,":focus");if(e&&e.length&&e.some(e=>hasClass(e,"noMemoryOnA")))return;global.state.papers&&dispatch("memory-switch","click")}else"Enter"===a&&("memory-switch-open"===(t=document.querySelector(":focus")).id?dispatch("memory-switch","click"):"menu-switch"===t.id?(dispatch("menu-switch","click"),dispatch("menu-switch","blur")):hasClass(t,"memory-item-svg-div")&&dispatch(t,"click"))},handlePrefsCheckChange=async e=>{const t=e.target.id,a=findEl(t).checked;if(global.state&&global.state.prefs)global.state.prefs[t]=a,setStorage("prefs",global.state.prefs,function(){log(`Settings saved for ${t} (${a})`)});else{const o=await getStorage("prefs")??{};o[t]=a,setStorage("prefs",o,function(){log(`Settings saved for ${t} (${a})`)})}a&&"checkNoAuto"===t&&chrome.commands.getAll(e=>{e=e.find(e=>"manualParsing"===e.name).shortcut;console.log("shortcut: ",e),e||showPopupModal("manualParsing")})},handlePopupSaveEdits=e=>{var{note:t,codeLink:a,favorite:o}=getPaperEdits(e,!0);updatePaperTags(e,"#popup-item-tags--"+e),saveNote(e,t),saveCodeLink(e,a),saveFavoriteItem(e,o),setStorage("syncPush",!0)},handlePopupDeletePaper=e=>()=>{showConfirmDeleteModal(e)},getMemoryItemHTML=(e,t)=>{var a=new Date(e.addDate).toLocaleString().replace(",",""),o=new Date(e.lastOpenDate).toLocaleString().replace(",",""),s=getDisplayId(e.id),r=e.note||"",i=e.id,l=new Set(e.tags),n=getTagsOptions(e),d=e.favorite?"favorite":"",c=(t.pdfLink="Open link to "+e.title,t.copyLink="Open link to the paper's "+(global.state.prefs.checkPreferPdf?"PDF":"abstract"),`<small class="memory-item-faded"><span class="memory-code-link">${e.codeLink||""}</span></small>`);let p='<div class="memory-note-div memory-item-faded"></div>';e.note&&(p=`<div class="memory-note-div memory-item-faded"><span class="note-content-header">Note:</span> <span class="note-content">${r}</span></div>`);var m=global.state.files.hasOwnProperty(e.id)?`<div class="memory-item-openLocal memory-item-svg-div" title="${t.openLocal}">${tablerSvg("vocabulary","",["memory-icon-svg"])}</div>`:"";return`<div class="memory-container ${d}" tabindex="0" id="memory-container--${i}"><h4 class="memory-title" title="Added ${a}
Last open ${o}"><span class="memory-item-favorite">${tablerSvg("star","",["memory-item-favorite-svg",d])} </span>${e.title}</h4><div class="my-1 mx-0"><small class="tag-list">${[...l].map(e=>`<span class="memory-tag">${e}</span>`).join("")}</small><div class="edit-tags p-0" style="display: none"><div class="flex-center-between"><span class="label">Tags:</span> <select class="memory-item-tags" id="memory-item-tags--${i}" multiple="multiple">${n}</select></div></div></div><small class="memory-authors">${cutAuthors(e.author)}</small><div class="code-and-note">${c} ${p}</div><div class="memory-item-actions flex-center-between mt-2"><div class="d-flex align-items-center"><div class="memory-item-edit memory-item-svg-div me-2" title="${t.edit}">${tablerSvg("writing","",["memory-icon-svg"])}</div><small class="memory-item-faded memory-display-id">${s}</small></div><div class="memory-item-link memory-item-svg-div" title="${t.pdfLink}">${tablerSvg("external-link","",["memory-icon-svg"])}</div>${m}<div class="memory-item-copy-link memory-item-svg-div" title="${t.copyLink}">${tablerSvg("link","",["memory-icon-svg"])}</div><div class="memory-item-md memory-item-svg-div" title="${t.copyMd}">${tablerSvg("markdown","",["memory-icon-svg"])}</div><div class="memory-item-bibtex memory-item-svg-div" title="${t.copyBibtext}">${tablerSvg("math-function","",["memory-icon-svg"])}</div><span style="display: none" class="memory-item-feedback"></span><div title="${t.visits}" class="memory-item-faded memory-visits">Visits: ${e.count}</div></div><div class="extended-item" style="display: none"><div class="item-note"><form class="form-note"><div class="flex-center-start"><span class="label">Code:</span> <input type="text" class="form-code-input" value="${e.codeLink||""}" placeholder="Add link"></div><div class="flex-center-start"><span class="label">Note:</span> <textarea rows="2" class="form-note-textarea" placeholder="Anything to note?">
${r}</textarea></div><div class="form-note-buttons"><button class="cancel-note-form back-to-focus">Done</button></div></form></div></div><div class="memory-delete" title="Delete from Memory">-</div></div>`},getPopupEditFormHTML=e=>{var t=e.id,a=getTagsOptions(e),o=e.note||"",s=getDisplayId(e.id);return`<div style="max-width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 4px 16px;"><div style="width: 100%"><div style="width: 100%; display: flex; justify-content: space-between; align-items: center;"><span class="label">Tags:</span> <select id="popup-item-tags--${t}" class="memory-item-tags" multiple="multiple">${a}</select></div><div class="form-note" id="popup-form-note--${t}" style="width: 100%; display: flex; justify-content: space-between; align-items: center; margin-top: 8px; flex-direction: column;"><div class="flex-center-start w-100 mr-0"><span class="label">Code:</span> <input id="popup-form-codeLink--${t}" type="text" class="form-code-input mt-0 noMemoryOnA" value="${e.codeLink||""}" placeholder="Add link"></div><div class="flex-center-start w-100 mr-0"><span class="label">Note:</span> <textarea rows="2" class="noMemoryOnA popup-form-note-textarea" id="popup-form-note-textarea--${t}" placeholder="Anything to note?">
${o}</textarea></div></div><div style="display: flex; justify-content: space-between; align-items: center"><div style="display: flex; justify-content: flex-start; align-items: center"><label class="label" for="checkFavorite">Favorite:</label> <input ${""} class="switch" type="checkbox" id="checkFavorite--${t}" name="checkFavorite" value="checkFavorite"></div><div id="popup-delete-paper" title="Delete paper from Memory"><svg width="25" height="25" viewBox="0 0 24 24" stroke-width="1" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke="white"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="7" x2="20" y2="7"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"/><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"/></svg></div><small id="popup-displayId">${s} </small><button hidden class="back-to-focus" id="popup-save-edits--${t}">Save</button></div></div></div>`},getPopupPaperIconsHTML=(e,t,a)=>{var o=e.id,t=isPdfUrl(t)?"HTML":"PDF";let s="";global.state.prefs.checkScirate&&"arxiv"===e.source&&(s=`<div tabindex="0" class="memory-item-svg-div" id="popup-memory-item-scirate--${o}" title="Open on SciRate">${tablerSvg("messages","",["popup-click-svg"])}</div>`);e=global.state.prefs.checkStore&&(a.localFile||a.stored)?`<div tabindex="0" class="memory-item-svg-div" id="popup-memory-item-openLocal--${o}" title="Open downloaded pdf">${tablerSvg("vocabulary","",["popup-click-svg"])}</div>`:`<div tabindex="0" class="memory-item-svg-div" id="popup-memory-item-download--${o}" title="Download pdf">${tablerSvg("file-download","",["popup-click-svg"])}</div>`;return`${s}<div tabindex="0" class="memory-item-svg-div" id="popup-memory-item-link--${o}" title="Open Paper ${t} Page">${tablerSvg("external-link","",["popup-click-svg"])}</div><div tabindex="0" class="memory-item-svg-div" id="popup-memory-item-copy-link--${o}" title="Copy link to paper">${tablerSvg("link","",["popup-click-svg"])}</div><div tabindex="0" class="memory-item-svg-div" id="popup-memory-item-md--${o}" title="Copy Markdown-formatted link">${tablerSvg("markdown","",["popup-click-svg"])}</div><div tabindex="0" class="memory-item-svg-div" id="popup-memory-item-bibtex--${o}" title="Copy Bibtex citation">${tablerSvg("math-function","",["popup-click-svg"])}</div>`+e},getTagsOptions=e=>{const o=new Set(e.tags);return[...global.state.paperTags].sort().map((e,t)=>{let a='<option value="'+e+'"';return o.has(e)&&(a+=' selected="selected" '),a+">"+e}).join("")},updateAllMemoryPaperTagOptions=()=>{for(const t in global.state.papers){var e;global.state.papers.hasOwnProperty(t)&&"__dataVersion"!==t&&(e=global.state.papers[t],setHTML("memory-item-tags--"+t,getTagsOptions(e)))}},sampleAsciiArt=async()=>{var e=chrome.runtime.getURL("src/data/art.json"),e=await fetch(e).then(e=>e.json()),t=Object.keys(e).length,t=Math.floor(Math.random()*t),[e,t]=Object.entries(e)[t];return{animal:e,ascii:t}},updatePopupPaperNoMemory=async o=>{var{animal:e,ascii:t}=await sampleAsciiArt();let a=`<div class="no-paper-div"><h3>This paper is not in your Memory  <span id="no-paper-why-span"><button class="code-font" id="no-paper-why-code">?</button></span></h3><div><div>Here's a ${e} for your trouble</div><br><div id="ascii-art-div"><div style="text-align:">${t}</div></div></div></div>`;e=-1<navigator.userAgent.search("Firefox")||global.state.prefs.checkNoAuto;e&&(a+='<div id="manual-trigger-wrapper"><div id="manual-trigger-btn">Try manual trigger</div><div id="manual-loader-container" class="pm-container" style="display: none;"><div class="sk-folding-cube"><div class="sk-cube1 sk-cube"></div><div class="sk-cube2 sk-cube"></div><div class="sk-cube4 sk-cube"></div><div class="sk-cube3 sk-cube"></div></div></div><div id="manual-parsing-error"></div></div>');const s=findEl("isArxiv").innerHTML;setHTML("isArxiv",a),addListener("no-paper-why-code","click",()=>{showPopupModal("noPaper")}),e&&addListener("manual-trigger-btn","click",async()=>{showId("manual-loader-container");try{var t=await isPaper(o);let e;var a=await addOrUpdatePaper({url:o,is:t});if(!a)return;(e=a.paper)&&(hideId("manual-loader-container"),setHTML("isArxiv",s),popupMain(o,t,!0))}catch(e){hideId("manual-loader-container"),setHTML("manual-parsing-error",`<strong>${"There was an issue parsing this paper. <br/> Raise an issue on Github if you think it is a bug.<br/>Attempted url: "+o}</strong>`),warn("Manual Parsing Error:",e)}})},showConfirmDeleteModal=e=>{var t=global.state.papers[e].title;setTextId("delete-modal-title",t),setHTML("delete-paper-modal-hidden-id",e),showId("delete-paper-modal","flex")},copyAndConfirmMemoryItem=(e,t,a,o)=>{copyTextToClipboard(t);const s=o?findEl("popup-feedback-copied"):findEl(e,"memory-item-feedback");s&&(s.innerText=a,fadeIn(s),setTimeout(()=>{fadeOut(s)},2e3))},focusExistingOrCreateNewCodeTab=s=>{(s=s.replace("http://","https://")).startsWith("https://")||(s="https://"+s);var e=new URL(s)["origin"];chrome.tabs.query({url:e+"/*"},e=>{for(const t of e)if(t.url.includes(s)){const a={active:!0},o={focused:!0};return void chrome.windows.getCurrent(e=>{e.id!==t.windowId?chrome.windows.update(t.windowId,o,()=>{chrome.tabs.update(t.id,a)}):chrome.tabs.update(t.id,a)})}chrome.tabs.create({url:s})})},focusExistingOrCreateNewPaperTab=(i,l)=>{chrome.tabs.query({},async e=>{var t=global.state.prefs;let a=[];for(const r of e){let e;try{e=r.url&&await parseIdFromUrl(r.url)}catch(e){}e&&e===i.id&&a.push(r)}let o;var s,e=t.checkPreferPdf?a.filter(e=>e.url&&isPdfUrl(e.url)):a.filter(e=>e.url&&!isPdfUrl(e.url));0<e.length?(s=l&&global.state.files.hasOwnProperty(i.id)?[]:a.filter(e=>e.url.startsWith("file://")),o=(0<s.length?s:e)[0]):0<a.length&&(o=a[0]),o?chrome.windows.getCurrent(e=>{e.id!==o.windowId?chrome.windows.update(o.windowId,{focused:!0},()=>{chrome.tabs.update(o.id,{active:!0})}):chrome.tabs.update(o.id,{active:!0})}):global.state.files.hasOwnProperty(i.id)&&!l?chrome.downloads.open(global.state.files[i.id].id):chrome.tabs.create({url:(t.checkPreferPdf?paperToPDF:paperToAbs)(i)}),global.state.papers[i.id].count+=1,chrome.storage.local.set({papers:global.state.papers})})},saveNote=(t,a)=>{global.state.papers[t].note=a,chrome.storage.local.set({papers:global.state.papers},()=>{setHTML(findEl(t,"memory-note-div"),a?`<div class="memory-note-div memory-item-faded"><span class="note-content-header">Note:</span> <span class="note-content">${a}</span></div>`:'<div class="memory-note-div memory-item-faded"></div>');var e=findEl("popup-form-note-textarea--"+t);val(e,a),val(findEl(t,"form-note-textarea"),a)})},saveCodeLink=(t,a)=>{a=a.trim(),global.state.papers[t].codeLink=a,chrome.storage.local.set({papers:global.state.papers},()=>{var e=a.replace(/^https?:\/\//,""),e=(setHTML(findEl(t,"memory-code-link"),e),setHTML("popup-code-link",e),val(findEl(t,"form-code-input"),a),(a?showId:hideId)("popup-code-link"),findEl("popup-form-codeLink--"+t));val(e,a)})},saveFavoriteItem=(o,s)=>{global.state.papers[o].favorite=s,global.state.papers[o].favoriteDate=(new Date).toJSON(),chrome.storage.local.set({papers:global.state.papers},()=>{var e,t;s?(addClass("memory-container--"+o,"favorite"),addClass(findEl(o,"memory-item-favorite").querySelector("svg"),"favorite")):(removeClass("memory-container--"+o,"favorite"),removeClass(findEl(o,"memory-item-favorite").querySelector("svg"),"favorite")),"favoriteDate"===global.state.sortKey&&(s||(sortMemory(),displayMemoryTable()),e=global.state.sortedPapers.filter(e=>e.favorite).length,(t=findEl("memory-search"))&&setPlaceholder(t,`Search ${e} entries`));let a=findEl("checkFavorite--"+o);a&&(a.checked=s)})},setMemorySortArrow=e=>{let t;t="up"===e?'<svg viewBox="0 0 24 24" class="memory-sort-arrow-svg" id="memory-sort-arrow-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="12" y1="5" x2="12" y2="19"/><line x1="16" y1="9" x2="12" y2="5"/><line x1="8" y1="9" x2="12" y2="5"/></svg>':'<svg class="memory-sort-arrow-svg" id="memory-sort-arrow-down" viewBox="0 0 24 24"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="12" y1="5" x2="12" y2="19"/><line x1="16" y1="15" x2="12" y2="19"/><line x1="8" y1="15" x2="12" y2="19"/></svg>',setHTML("memory-sort-arrow",t)},reverseMemory=()=>{global.state.sortedPapers.reverse(),global.state.papersList.reverse()},searchMemory=e=>{const t=e.toLowerCase().split(" ");let a=[];for(const o of global.state.sortedPapers){const s=o.title.toLowerCase(),r=o.author.toLowerCase(),i=o.note.toLowerCase(),l=o.tags.join(" ").toLowerCase(),n=getDisplayId(o.id).toLowerCase(),d=o.venue.toLowerCase();!t.every(e=>s.includes(e)||r.includes(e)||i.includes(e)||l.includes(e)||n.includes(e)||d.includes(e))||global.state.showFavorites&&!o.favorite||a.push(o)}global.state.papersList=a},searchMemoryByYear=e=>{var t=e.includes("<")?"smaller":e.includes(">")?"greater":"";const a=e.replace("y:","").replace(/(<|>)/g,"").toLowerCase().replaceAll(","," ").split(" ").filter(e=>0<e.length).map(e=>4===e.length?e:"20"+e).map(e=>parseInt(e,10));console.log("searchYears: ",a);let o=[],s=(e,t)=>e===t;"smaller"==t?s=(e,t)=>t<e:"greater"==t&&(s=(e,t)=>e<t);for(const r of global.state.sortedPapers){const i=parseInt(r.year,10);a.some(e=>s(e,i))&&o.push(r)}global.state.papersList=o},searchMemoryByTags=e=>{const t=e.replace("t:","").toLowerCase().split(" ");let a=[];for(const o of global.state.sortedPapers){const s=o.tags.map(e=>e.toLowerCase());!t.every(t=>s.some(e=>0<=e.indexOf(t)))||global.state.showFavorites&&!o.favorite||a.push(o)}global.state.papersList=a},searchMemoryByCode=e=>{const a=e.replace("c:","").toLowerCase().split(" ");let o=[];for(const s of global.state.sortedPapers){let t=s.codeLink||"";t=t.toLowerCase(),!a.every(e=>t.includes(e))||global.state.showFavorites&&!s.favorite||o.push(s)}global.state.papersList=o},updatePaperTagsHTML=e=>{setHTML(findEl(e,"tag-list"),global.state.papers[e].tags.map(e=>`<span class="memory-tag">${e}</span>`).join(""))},updateTagOptions=e=>{updateAllMemoryPaperTagOptions();var t=getTagsOptions(global.state.papers[e]);setHTML("popup-item-tags--"+e,t)},updatePaperTags=(t,e)=>{let a;a=e.startsWith("#")?findEl(e.replace("#","")):findEl(t,e);e=parseTags(a);let o=!1;new Set;arraysIdentical(global.state.papers[t].tags,e)||(o=!0),global.state.papers[t].tags=e,o&&chrome.storage.local.set({papers:global.state.papers},()=>{makeTags(),updateTagOptions(t),updatePaperTagsHTML(t);for(const e of queryAll(findEl(t,"tag-list"),".memory-tag"))addListener(e,"click",handleTagClick)})},displayOnScroll=o=>delay(()=>{var e=findEl("memory-table").getBoundingClientRect()["bottom"],t=o?findEl("memory-container").getBoundingClientRect().height:window.innerHeight,a=global.state.currentMemoryPagination*global.state.memoryItemsPerPage;Math.abs(e-t)<t&&a<global.state.papersList.length&&(global.state.currentMemoryPagination+=1,displayMemoryTable(global.state.currentMemoryPagination))},50),displayMemoryTable=(e=0)=>{var t=Date.now(),a=findEl("memory-table"),o=(0===e&&(setHTML(a,""),global.state.currentMemoryPagination=0),{edit:"Edit paper details",copyMd:"Copy Markdown-formatted link",copyBibtext:"Copy Bibtex citation",visits:"Number of times you have opened this paper",openLocal:"Open downloaded pdf"});let s=[];for(const r of global.state.papersList.slice(e*global.state.memoryItemsPerPage,(e+1)*global.state.memoryItemsPerPage))try{s.push(getMemoryItemHTML(r,o))}catch(e){log("displayMemoryTable error:"),log(e),log(r)}0===e?setHTML(a,s.join("")):a.insertAdjacentHTML("beforeend",s.join("")),addEventToClass(".back-to-focus","click",handleBackToFocus),addEventToClass(".memory-delete","click",handleDeleteItem),addEventToClass(".memory-item-link","click",handleOpenItemLink),addEventToClass(".memory-code-link","click",handleOpenItemCodeLink),addEventToClass(".memory-item-md","click",handleCopyMarkdownLink),addEventToClass(".memory-item-bibtex","click",handleCopyBibtex),addEventToClass(".memory-item-copy-link","click",handleCopyPDFLink),addEventToClass(".memory-item-openLocal","click",handleMemoryOpenLocal),addEventToClass(".memory-item-favorite","click",handleAddItemToFavorites),addEventToClass(".cancel-note-form","click",handleCancelPaperEdit),addEventToClass(".memory-item-edit","click",handleTogglePaperEdit),addEventToClass(".memory-tag","click",handleTagClick),setFormChangeListener(void 0,!1),addEventToClass(".form-note-textarea","focus",handleTextareaFocus);e=Date.now();info("Display duration (s): "+(e-t)/1e3)},makeMemoryHTML=async()=>{setPlaceholder("memory-search",`Search ${global.state.papersList.length} entries ...`),displayMemoryTable();let e=300;global.state.papersList.length<20?e=0:global.state.papersList.length<100&&(e=150),addListener("memory-search","keypress",delay(handleMemorySearchKeyPress(),e)),addListener("memory-search","clear-search",handleMemorySearchKeyPress(!0)),addListener("memory-search","keyup",handleMemorySearchKeyUp),addListener("delete-paper-modal-cancel-button","click",handleCancelModalClick),addListener("delete-paper-modal-confirm-button","click",handleConfirmDeleteModalClick),addListener("filter-favorites","click",handleFilterFavorites),addListener("memory-select","change",handleMemorySelectChange),addListener("memory-sort-arrow","click",handleMemorySortArrow),addListener("memory-container","scroll",displayOnScroll(!0))},openMemory=()=>{global.state.prefsIsOpen&&closeMenu(),global.state.memoryIsOpen=!0,hideId("memory-switch-open"),showId("memory-switch-close"),hideId("menu-switch"),dispatch("memory-switch","blur"),slideDown("memory-container",200,()=>{setTimeout(()=>{dispatch("memory-search","focus")},100)}),setTimeout(()=>{addListener("memory-search-clear-icon","click",handleClearSearch),val("memory-select","lastOpenDate"),setMemorySortArrow("down")},200)},closeMemory=()=>{dispatch("memory-switch","blur"),hideId("memory-switch-close"),showId("memory-switch-open"),slideUp("memory-container",200,()=>{val("memory-search",""),dispatch("memory-search","clear-search"),global.state.memoryIsOpen=!1,global.state.showFavorites&&dispatch("filter-favorites","click"),showId("menu-switch","flex")})},closeMenu=()=>{slideUp("menu-container",300),setHTML("menu-switch",tablerSvg("settings","menu-switch-svg",["tabler-icon","menu-svg"])),dispatch("menu-switch","blur"),global.state.prefsIsOpen=!1},openMenu=()=>{slideDown("menu-container",300),dispatch("menu-switch","blur"),setHTML("menu-switch",tablerSvg("circle-x","close-menu-btn",["tabler-icon","menu-svg"])),global.state.prefsIsOpen=!0},getAndTrackPopupMenuChecks=(e,t)=>{let a={};for(const o of t){a[o]=e.hasOwnProperty(o)?e[o]:!(0<=global.prefsCheckDefaultFalse.indexOf(o));const s=findEl(o);s&&(s.checked=a[o])}setStorage("prefs",a);for(const r of t)addListener(r,"change",handlePrefsCheckChange)},showPopupModal=e=>{document.querySelectorAll(".popup-modal-content").forEach(hideId),showId(`modal-${e}-content`,"contents"),style("popup-modal-wrapper","display","flex"),[...document.getElementsByTagName("a")].forEach(e=>{addListener(e,"click",()=>{chrome.tabs.create({url:e.getAttribute("href")})})})},setStandardPopupClicks=()=>{addListener("helpGithubLink","click",()=>{chrome.tabs.create({url:"https://github.com/vict0rsch/PaperMemory"})}),addListener("whats-new-container","click",()=>{chrome.storage.local.get("whatsnew",({whatsnew:e})=>{var t=chrome.runtime.getManifest().version;(e=void 0===e?{}:e).hasOwnProperty(t)||hideId("whats-new-marker"),chrome.storage.local.set({whatsnew:{...e,[t]:!0}}),showPopupModal("whatsnew")})}),addListener("keyboardShortcuts","click",()=>{showPopupModal("keyboard")}),addListener("keyboardShortcutsMenu","click",()=>{showPopupModal("keyboard")}),shouldWarn("pdf-title",e=>{e&&(showId("warning-button"),addListener("warning-button","click",async()=>{showPopupModal("warning-pdf-title");let e=await getStorage("userWarnings")??{};e["pdf-title"]=!0,setStorage("userWarnings",e),hideId("warning-button")}))}),addListener("close-popup-modal","click",()=>{style("popup-modal-wrapper","display","none")}),addListener(window,"click",e=>{e.target===findEl("popup-modal-wrapper")&&style("popup-modal-wrapper","display","none")}),addListener("menu-switch","click",()=>{(global.state.prefsIsOpen?closeMenu:openMenu)()}),addListener("memory-switch","click",handleMemorySwitchClick)},popupMain=async(a,e,t=!1)=>{console.log(navigator.userAgent),"PuppeteerAgent"===navigator.userAgent&&info("Is puppet"),addListener(document,"keydown",handlePopupKeydown),chrome.storage.local.get("whatsnew",({whatsnew:e})=>{var t=chrome.runtime.getManifest().version;e&&e.hasOwnProperty(t)||showId("whats-new-marker")}),t?(hideId("memory-switch"),showId("memory-spinner"),await initSyncAndState(),hideId("memory-spinner"),showId("memory-switch"),makeMemoryHTML()):setStandardPopupClicks();const o=await getPrefs();if(getAndTrackPopupMenuChecks(o,global.prefsCheckNames),addListener("advanced-configuration","click",()=>{chrome.runtime.openOptionsPage()}),addListener("full-memory","click",()=>{chrome.tabs.create({url:chrome.extension.getURL("src/fullMemory/fullMemory.html")})}),Object.values(e).some(e=>e)){setTimeout(()=>{document.body.style.height="auto",document.body.style.minHeight="450px"},0),showId("isArxiv","flex");const s=await parseIdFromUrl(a);if(!(global.state.currentId=s)||!global.state.papers.hasOwnProperty(s))return log("Unknown id "+s),await updatePopupPaperNoMemory(a),void(o.checkDirectOpen&&!o.checkNoAuto&&dispatch("memory-switch","click"));const r=global.state.papers[s];t=r.id.replaceAll(".","\\.");setTextId("popup-paper-title",r.title.replaceAll("\n","")),setTextId("popup-authors",cutAuthors(r.author,350).replace(/({|})/g,"")),r.codeLink&&(showId("popup-code-link"),setTextId("popup-code-link",r.codeLink.replace(/^https?:\/\//,""))),log("Popup paper:",r),setHTML("popup-memory-edit",getPopupEditFormHTML(r)),setHTML("popup-copy-icons",getPopupPaperIconsHTML(r,a,e)),findEl("checkFavorite--"+s).checked=r.favorite,$("#popup-item-tags--"+t).select2({...global.select2Options,width:"87%"}),addListener("popup-form-note-textarea--"+s,"focus",()=>{textareaFocusEnd(this)}),setFormChangeListener(s,!0),addListener("popup-delete-paper","click",handlePopupDeletePaper(s)),addListener("popup-memory-item-scirate--"+s,"click",()=>{var e=r.id.split("-").last();chrome.tabs.update({url:"https://scirate.com/arxiv/"+e}),window.close()}),addListener("popup-memory-item-link--"+s,"click",()=>{var e=paperToPDF(r),t=paperToAbs(r);chrome.tabs.update({url:isPdfUrl(a)?t:e}),window.close()}),addListener("popup-code-link","click",()=>{var e=findEl("popup-code-link").textContent;e&&focusExistingOrCreateNewCodeTab(e)}),addListener("popup-memory-item-copy-link--"+s,"click",()=>{var e=(o.checkPreferPdf?paperToPDF:paperToAbs)(r),t=o.checkPreferPdf?"PDF":"Abstract";copyAndConfirmMemoryItem(s,e,t+" link copied!",!0)}),addListener("popup-memory-item-md--"+s,"click",()=>{var e=global.state.prefs,t=(console.log("state.prefs: ",state.prefs),makeMdLink(r,e)),e=e.checkPreferPdf?"PDF":"Abstract";copyAndConfirmMemoryItem(s,t,`Markdown link to ${e} copied!`,!0)}),addListener("popup-memory-item-bibtex--"+s,"click",()=>{var e=bibtexToString(global.state.papers[s].bibtex);copyAndConfirmMemoryItem(s,e,"Bibtex citation copied!",!0)}),addListener("popup-memory-item-openLocal--"+s,"click",async()=>{var e=await findLocalFile(r);e?chrome.downloads.open(e.id):chrome.tabs.create({url:r.pdfLink})}),addListener("popup-memory-item-download--"+s,"click",async()=>{downloadPaperPdf(r)})}else o.checkDirectOpen&&dispatch("memory-switch","click")},query={active:!0,lastFocusedWindow:!0};window.location.href.includes("popup")&&chrome.tabs.query(query,async e=>{chrome.runtime.connect({name:"PaperMemoryPopupSync"});e=e[0].url;let a,t;t=new Promise(t=>{a=new Promise(e=>{initSyncAndState({stateIsReady:e,remoteIsReady:t})})}),await a;var o=await isPaper(e);Object.values(o).some(e=>e)||showId("notArxiv"),hideId("memory-spinner"),showId("memory-switch"),makeMemoryHTML(),popupMain(e,o),-1<navigator.userAgent.search("Firefox")&&hideId("overwrite-container"),await t,global.state.currentId&&!global.state.papers[global.state.currentId]&&(global.state.currentId=null,makeMemoryHTML(),await updatePopupPaperNoMemory(e))});