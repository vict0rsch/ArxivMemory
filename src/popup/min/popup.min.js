const addEventToClass=(e,t,a)=>{document.querySelectorAll(e).forEach(e=>{e.addEventListener(t,a)})},handleBackToFocus=e=>{const t=eventId(e);setTimeout(()=>{document.getElementById("memory-container--"+t).dispatchEvent(new Event("focus"))},250)},handleDeleteItem=e=>{e=eventId(e);showConfirmDeleteModal(e)},handleOpenItemLink=e=>{e=eventId(e);focusExistingOrCreateNewPaperTab(global.state.papers[e])},handleOpenItemCodeLink=e=>{e=eventId(e),e=global.state.papers[e].codeLink;focusExistingOrCreateNewCodeTab(e)},handleCopyMarkdownLink=e=>{var t=eventId(e),e=global.state.papers[t].md;copyAndConfirmMemoryItem(t,e,"Markdown link copied!")},handleCopyBibtex=e=>{var t=eventId(e),e=global.state.papers[t].bibtex;copyAndConfirmMemoryItem(t,formatBibtext(e),"Bibtex copied!")},handleCopyPDFLink=e=>{var t=eventId(e),e=global.state.papers[t].pdfLink;copyAndConfirmMemoryItem(t,e,"Pdf link copied!")},handleAddItemToFavorites=e=>{var t=eventId(e),e=hasClass("memory-container--"+t,"favorite");saveFavoriteItem(t,!e)},handleTextareaFocus=()=>{textareaFocusEnd(this)},handleMemorySaveEdits=e=>{var{note:t,codeLink:a}=getPaperEdits(e);saveNote(e,t),saveCodeLink(e,a),updatePaperTags(e,"memory-item-tags")},handleCancelPaperEdit=e=>{e.preventDefault();var t=eventId(e),e=global.state.papers[t];val(findEl(t,"form-note-textarea"),e.note),setHTML(findEl(t,"memory-item-tags"),getTagsOptions(e)),dispatch(findEl(t,"memory-item-edit"),"click")},handleTogglePaperEdit=e=>{e.preventDefault();var t=eventId(e);const a=findEl("memory-container--"+t);var o=findEl(t,"code-and-note"),s=findEl(t,"extended-item"),r=findEl(t,"tag-list"),i=findEl(t,"memory-authors"),l=findEl(t,"edit-tags"),e=findEl(t,"memory-item-actions");const n=$(findEl(t,"memory-item-tags"));hasClass(a,"expand-open")?(removeClass(a,"expand-open"),slideDown(o,150),slideDown(r,150),slideDown(e,150),slideDown(i,150),slideUp(s,150),slideUp(l,150),setTimeout(()=>{n.select2("destroy")},500)):(addClass(a,"expand-open"),n.select2({...global.select2Options,width:"86%"}),hasClass(a,"has-monitoring")||n.on("change",monitorPaperEdits(t,!1)),a.classList.add("has-monitoring"),slideUp(o,150),slideUp(r,150),slideUp(e,150),slideUp(i,150),slideDown(s,150),slideDown(l,150))},handleMemorySelectChange=e=>{e=e.target.value;global.state.sortKey=e,sortMemory(),displayMemoryTable(),setMemorySortArrow("down")},handleMemorySortArrow=e=>{"memory-sort-arrow-down"===document.querySelector("#memory-sort-arrow svg").id?setMemorySortArrow("up"):setMemorySortArrow("down"),reverseMemory(),displayMemoryTable()},handleFilterFavorites=()=>{var e,t=!global.state.showFavorites;(global.state.showFavorites=t)?(addClass(findEl("filter-favorites").querySelector("svg"),"favorite"),sortMemory(),global.state.papersList=global.state.papersList.filter(e=>e.favorite),displayMemoryTable(),setMemorySortArrow("down"),findEl("memory-select").innerHTML+='<option value="favoriteDate">Last favoured</option>',e=global.state.papersList.length,setPlaceholder("memory-search",`Search ${e} entries...`)):(removeClass(findEl("filter-favorites").querySelector("svg"),"favorite"),"favoriteDate"===val("memory-select")&&(val("memory-select","lastOpenDate"),global.state.sortKey="lastOpenDate"),document.querySelector('#memory-select option[value="favoriteDate"]').remove(),sortMemory(),setMemorySortArrow("down"),val("memory-search").trim()?dispatch("memory-search","keypress"):(global.state.papersList=global.state.sortedPapers,displayMemoryTable()),e=global.state.sortedPapers.length,setPlaceholder("memory-search",`Search ${e} entries...`))},handleMemorySearchKeyPress=a=>e=>{const t=val("memory-search").trim();if(log(t),t||setTimeout(()=>{style("memory-search-clear-icon","visibility","hidden")},0),!t){if(global.state.papersList.length!==global.state.sortedPapers.length)return global.state.papersList=global.state.sortedPapers,void displayMemoryTable();if(!a&&"Backspace"!==e.key)return}style("memory-search-clear-icon","visibility","visible"),(t.startsWith("t:")?filterMemoryByTags:t.startsWith("c:")?filterMemoryByCode:filterMemoryByString)(t),displayMemoryTable()},handleMemorySearchKeyUp=e=>{var t;"Backspace"==e.key&&((t=new Event("keypress")).key="Backspace",dispatch("memory-search",t)),"memory-search"===e.target.id&&dispatch("memory-search","keypress")},handleCancelModalClick=()=>{hideId("confirm-modal")},handleConfirmDeleteModalClick=e=>{const t=findEl("hidden-modal-id").innerHTML,a=global.state.papers[t].title,o=global.state.papers[t].pdfLink;delete global.state.papers[t],chrome.storage.local.set({papers:global.state.papers},()=>{global.state.papersList=Object.values(cleanPapers(global.state.papers)),sortMemory(),displayMemoryTable(),hideId("confirm-modal"),log(`Successfully deleted "${a}" (${t}) from PaperMemory`),global.state.currentId===t&&updatePopupPaperNoMemory(o),setPlaceholder("memory-search",`Search ${global.state.papersList.length} entries ...`),addListener("memory-switch","click",handleMemorySwitchClick)})},handleTagClick=e=>{e=e.target.textContent;val("memory-search","t: "+e),dispatch("memory-search","keypress")},handleClearSearch=e=>{val("memory-search",""),dispatch("memory-search","clear-search"),style("memory-search-clear-icon","visibility","hidden")},handleMemorySwitchClick=()=>{(global.state.memoryIsOpen?closeMemory:openMemory)()},handlePopupKeydown=t=>{var a=t.key;if(!(["Backspace","Enter","Escape","a","e"].indexOf(a)<0))if(global.state.menuIsOpen)"Escape"===a?(t.preventDefault(),closeMenu()):"Enter"===a&&document.querySelector("#menu-switch:focus")&&closeMenu();else if(global.state.memoryIsOpen){if("Enter"===a){if(document.querySelector("#filter-favorites:focus"))return void dispatch("filter-favorites","click");if(document.querySelector("#memory-sort-arrow:focus")&&"Enter"===a)return void dispatch("memory-sort-arrow","click")}let e;const o=document.querySelector(".memory-container:focus");if("Escape"!==a){if(!o)return;e=o.id.split("--")[1]}"Backspace"===a?dispatch(findEl(e,"memory-delete"),"click"):"Enter"===a?dispatch(findEl(e,"memory-item-link"),"click"):"Escape"===a?(t.preventDefault(),o&&hasClass(o,"expand-open")?handleTogglePaperEdit(t):closeMemory()):"e"===a&&dispatch(findEl(e,"memory-item-edit"),"click")}else if("a"===a){t=document.querySelectorAll(":focus");if(t&&t.length&&Array.from(t).some(e=>hasClass(e,"noMemoryOnA")))return;global.state.papers&&dispatch("memory-switch","click")}else"Enter"===a&&("memory-switch-open"===(a=document.querySelector(":focus")).id?dispatch("memory-switch","click"):"menu-switch"===a.id?(dispatch("menu-switch","click"),dispatch("menu-switch","blur")):hasClass(a,"memory-item-svg-div")&&dispatch(a,"click"))},handleMenuCheckChange=e=>{const t=e.target.id,a=findEl(t).checked;chrome.storage.local.set({[t]:a},function(){log(`Settings saved for ${t} (${a})`)})},handlePopupSaveEdits=e=>{var{note:t,codeLink:a,favorite:o}=getPaperEdits(e,!0);updatePaperTags(e,"#popup-item-tags--"+e),saveNote(e,t),saveCodeLink(e,a),saveFavoriteItem(e,o)},handlePopupDeletePaper=e=>()=>{showConfirmDeleteModal(e)},getMemoryItemHTML=e=>{var t=new Date(e.addDate).toLocaleString().replace(",",""),a=new Date(e.lastOpenDate).toLocaleString().replace(",",""),o=getDisplayId(e.id),s=e.note||"",r=e.id,i=new Set(e.tags),l=getTagsOptions(e),n=e.favorite?"favorite":"";const d=`"Edit paper details (or press 'e' when this paper is focused, i.e. when you navigated to it with 'tab')"`,c=`"Open ${e.pdfLink}"`,m='"Copy pdf link"',p='"Copy Markdown-formatted link"',y='"Copy Bibtex citation"',h=`"Number of times you have loaded the paper's Page or PDF"`;var v=`<small class="memory-item-faded"><span class="memory-code-link">${e.codeLink||""}</span></small>`;let g='<div class="memory-note-div memory-item-faded"></div>';return e.note&&(g=`<div class="memory-note-div memory-item-faded"><span class="note-content-header">Note:</span> <span class="note-content">${s}</span></div>`),`<div class="memory-container ${n}" tabindex="0" id="memory-container--${r}"><h4 class="memory-title" title="Added ${t}
Last open ${a}"><span class="memory-item-favorite">${tablerSvg("star","",["memory-item-favorite-svg",n])} </span>${e.title}</h4><div class="my-1 mx-0"><small class="tag-list">${Array.from(i).map(e=>`<span class="memory-tag">${e}</span>`).join("")}</small><div class="edit-tags p-0" style="display: none"><div class="flex-center-between"><span class="label">Tags:</span> <select class="memory-item-tags" id="memory-item-tags--${r}" multiple="multiple">${l}</select></div></div></div><small class="memory-authors">${cutAuthors(e.author)}</small><div class="code-and-note">${v} ${g}</div><div class="memory-item-actions flex-center-between mt-2"><div class="d-flex align-items-center"><div class="memory-item-edit memory-item-svg-div me-2" title="${d}">${tablerSvg("writing","",["memory-icon-svg"])}</div><small class="memory-item-faded memory-display-id">${o}</small></div><div class="memory-item-link memory-item-svg-div" title="${c}">${tablerSvg("file-symlink","",["memory-icon-svg"])}</div><div class="memory-item-copy-link memory-item-svg-div" title="${m}">${tablerSvg("link","",["memory-icon-svg"])}</div><div class="memory-item-md memory-item-svg-div" title="${p}">${tablerSvg("clipboard-list","",["memory-icon-svg"])}</div><div class="memory-item-bibtex memory-item-svg-div" title="${y}">${tablerSvg("archive","",["memory-icon-svg"])}</div><span style="display: none" class="memory-item-feedback"></span><div title="${h}" class="memory-item-faded memory-visits">Visits: ${e.count}</div></div><div class="extended-item" style="display: none"><div class="item-note"><form class="form-note"><div class="flex-center-start"><span class="label">Code:</span> <input type="text" class="form-code-input" value="${e.codeLink||""}" placeholder="Add link"></div><div class="flex-center-start"><span class="label">Note:</span> <textarea rows="2" class="form-note-textarea" placeholder="Anything to note?">
${s}</textarea></div><div class="form-note-buttons"><button class="cancel-note-form back-to-focus">Done</button></div></form></div></div><div class="memory-delete" title="Delete from Memory">-</div></div>`},getPopupEditFormHTML=e=>{var t=e.id,a=getTagsOptions(e),o=e.note||"",s=getDisplayId(e.id);return`<div style="max-width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 4px 16px;"><div style="width: 100%"><div style="width: 100%; display: flex; justify-content: space-between; align-items: center;"><span class="label">Tags:</span> <select id="popup-item-tags--${t}" class="memory-item-tags" multiple="multiple">${a}</select></div><div class="form-note" id="popup-form-note--${t}" style="width: 100%; display: flex; justify-content: space-between; align-items: center; margin-top: 8px; flex-direction: column;"><div class="flex-center-start w-100 mr-0"><span class="label">Code:</span> <input id="popup-form-codeLink--${t}" type="text" class="form-code-input mt-0 noMemoryOnA" value="${e.codeLink||""}" placeholder="Add link"></div><div class="flex-center-start w-100 mr-0"><span class="label">Note:</span> <textarea rows="2" class="noMemoryOnA popup-form-note-textarea" id="popup-form-note-textarea--${t}" placeholder="Anything to note?">
${o}</textarea></div></div><div style="display: flex; justify-content: space-between; align-items: center"><div style="display: flex; justify-content: flex-start; align-items: center"><label class="label" for="checkFavorite">Favorite:</label> <input ${""} class="switch" type="checkbox" id="checkFavorite--${t}" name="checkFavorite" value="checkFavorite"></div><div id="popup-delete-paper" title="Delete paper from Memory"><svg width="25" height="25" viewBox="0 0 24 24" stroke-width="1" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke="white"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="7" x2="20" y2="7"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"/><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"/></svg></div><small id="popup-displayId">${s} </small><button hidden class="back-to-focus" id="popup-save-edits--${t}">Save</button></div></div></div>`},getPopupPaperIconsHTML=(e,t)=>{var a=e.id,t=paperToAbs(e)===t?"HTML":"PDF";let o="";return global.state.menu.checkScirate&&"arxiv"===e.source&&(o=`<div tabindex="0" class="memory-item-svg-div" id="popup-memory-item-scirate--${a}" title="Open on SciRate">${tablerSvg("messages","",["popup-click-svg"])}</div>`),`${o}<div tabindex="0" class="memory-item-svg-div" id="popup-memory-item-link--${a}" title="Open Paper ${t} Page">${tablerSvg("external-link","",["popup-click-svg"])}</div><div tabindex="0" class="memory-item-svg-div" id="popup-memory-item-copy-link--${a}" title="Copy pdf link">${tablerSvg("link","",["popup-click-svg"])}</div><div tabindex="0" class="memory-item-svg-div" id="popup-memory-item-md--${a}" title="Copy Markdown-formatted link">${tablerSvg("clipboard-list","",["popup-click-svg"])}</div><div tabindex="0" class="memory-item-svg-div" id="popup-memory-item-bibtex--${a}" title="Copy Bibtex citation">${tablerSvg("archive","",["popup-click-svg"])}</div><div tabindex="0" class="memory-item-svg-div" id="popup-memory-item-download--${a}" title="Download pdf">${tablerSvg("file-download","",["popup-click-svg"])}</div>`},getTagsOptions=e=>{const o=new Set(e.tags);return Array.from(global.state.paperTags).sort().map((e,t)=>{let a='<option value="'+e+'"';return o.has(e)&&(a+=' selected="selected" '),a+">"+e}).join("")},updateAllMemoryPaperTagOptions=()=>{for(const t in global.state.papers){var e;global.state.papers.hasOwnProperty(t)&&"__dataVersion"!==t&&(e=global.state.papers[t],setHTML("memory-item-tags--"+t,getTagsOptions(e)))}},updatePopupPaperNoMemory=o=>{let e=`<div style="font-size: 1.5rem; width: 100%; text-align: center;">This paper is not in your memory</div><ul>It can be for one of 4 reasons:<li style="margin-top: 4px">On Firefox, content scripts are not triggered on pdfs.<ul><li>This is not something I can do anything about, it's a known issue but a design choice by Firefox's developers.</li><li>The extension would work on the paper's <i>page</i> (for instance arxiv.org/<strong>abs</strong>/1106.0245)</li></ul></li><li style="margin-top: 4px">You deleted the paper (refresh the page to add it back)</li><li style="margin-top: 4px">There was an error parsing the paper's data (you can check the console if you think this is an issue)</li><li style="margin-top: 4px">You are actually not on a paper page but the extension made a mistake</li><p style="font-size: 0.9rem">Open an issue on <a href="https://github.com/vict0rsch/PaperMemory/issues">Github</a> if you think you encountered a malfunction.</p></ul>`;-1<navigator.userAgent.search("Firefox")&&(e+='<div id="manual-firefox">Try manual trigger</div>');const s=findEl("isArxiv").innerHTML;setHTML("isArxiv",e),-1<navigator.userAgent.search("Firefox")&&addListener("manual-firefox","click",async()=>{var e=isPaper(o);let t;var a=await addOrUpdatePaper(o,e);a&&(t=a.paper,log("paper: ",t),log("previousIsArxiv: ",s),log("url: ",o),e=Object.values(e).some(e=>e),log("isKnownPage: ",e),t&&(setHTML("isArxiv",s),popupMain(o,e,!0)))})},showConfirmDeleteModal=e=>{var t=global.state.papers[e].title;setTextId("delete-modal-title",t),setHTML("hidden-modal-id",e),showId("confirm-modal","flex")},copyAndConfirmMemoryItem=(e,t,a,o)=>{copyTextToClipboard(t);const s=o?findEl("popup-feedback-copied"):findEl(e,"memory-item-feedback");s&&(s.innerText=a,$(s).fadeIn(),setTimeout(()=>{$(s).fadeOut()},2e3))},focusExistingOrCreateNewCodeTab=s=>{(s=s.replace("http://","https://")).startsWith("https://")||(s="https://"+s);var e=new URL(s)["origin"];chrome.tabs.query({url:e+"/*"},e=>{for(const t of e)if(t.url.includes(s)){const a={active:!0},o={focused:!0};return void chrome.windows.getCurrent(e=>{e.id!==t.windowId?chrome.windows.update(t.windowId,o,()=>{chrome.tabs.update(t.id,a)}):chrome.tabs.update(t.id,a)})}chrome.tabs.create({url:s})})},focusExistingOrCreateNewPaperTab=l=>{var e=parseUrl(l.pdfLink).hostname;let n=l.pdfLink.split("/").reverse()[0].replace("-Paper.pdf","").replace(".pdf","").split("?").reverse()[0];"biorxiv"===l.source&&(n=cleanBiorxivURL(l.pdfLink)),n.match(/\d{5}v\d+$/)&&"arxiv"===l.source&&(n=n.split("v")[0]),chrome.tabs.query({url:`*://${e}/*`},e=>{let a=[],o=[];let t=0;for(const s of e.map(e=>e.url))0<=s.indexOf(n)&&(a.push(t),s.endsWith(".pdf")&&o.push(t)),t+=1;if(0<a.length){let t;t=0<o.length?e[o[0]]:e[a[0]];const r={active:!0},i={focused:!0};chrome.windows.getCurrent(e=>{e.id!==t.windowId?chrome.windows.update(t.windowId,i,()=>{chrome.tabs.update(t.id,r)}):chrome.tabs.update(t.id,r)})}else global.state.menu.checkStore?chrome.downloads.search({filenameRegex:"PaperMemoryStore/.*"},e=>{var t,a;for(const o of e=e.filter(e=>e.exists)){if(o.filename.toLowerCase().includes(l.title.toLowerCase())){t=o;break}try{a=parseIdFromUrl(o.finalUrl)}catch(e){a=""}if(paperToPDF({pdfLink:o.finalUrl,id:a,source:l.source})===paperToPDF(l)){t=o;break}}t?chrome.downloads.open(t.id):chrome.tabs.create({url:l.pdfLink})}):chrome.tabs.create({url:l.pdfLink});global.state.papers[l.id].count+=1,chrome.storage.local.set({papers:global.state.papers})})},saveNote=(t,a)=>{global.state.papers[t].note=a,chrome.storage.local.set({papers:global.state.papers},()=>{setHTML(findEl(t,"memory-note-div"),a?`<div class="memory-note-div memory-item-faded"><span class="note-content-header">Note:</span> <span class="note-content">${a}</span></div>`:'<div class="memory-note-div memory-item-faded"></div>');var e=findEl("popup-form-note-textarea--"+t);val(e,a),val(findEl(t,"form-note-textarea"),a)})},saveCodeLink=(t,a)=>{a=a.trim(),global.state.papers[t].codeLink=a,chrome.storage.local.set({papers:global.state.papers},()=>{var e=a.replace(/^https?:\/\//,"");setHTML(findEl(t,"memory-code-link"),e),setHTML("popup-code-link",e),val(findEl(t,"form-code-input"),a),(a?showId:hideId)("popup-code-link");e=findEl("popup-form-codeLink--"+t);val(e,a)})},saveFavoriteItem=(o,s)=>{global.state.papers[o].favorite=s,global.state.papers[o].favoriteDate=(new Date).toJSON(),chrome.storage.local.set({papers:global.state.papers},()=>{var e,t;s?(addClass("memory-container--"+o,"favorite"),addClass(findEl(o,"memory-item-favorite").querySelector("svg"),"favorite")):(removeClass("memory-container--"+o,"favorite"),removeClass(findEl(o,"memory-item-favorite").querySelector("svg"),"favorite")),"favoriteDate"===global.state.sortKey&&(s||(sortMemory(),displayMemoryTable()),e=global.state.sortedPapers.filter(e=>e.favorite).length,(t=findEl("memory-search"))&&setPlaceholder(t,`Search ${e} entries`));let a=findEl("checkFavorite--"+o);a&&(a.checked=s)})},setMemorySortArrow=e=>{let t;t="up"===e?'<svg viewBox="0 0 24 24" class="memory-sort-arrow-svg" id="memory-sort-arrow-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="12" y1="5" x2="12" y2="19"/><line x1="16" y1="9" x2="12" y2="5"/><line x1="8" y1="9" x2="12" y2="5"/></svg>':'<svg class="memory-sort-arrow-svg" id="memory-sort-arrow-down" viewBox="0 0 24 24"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="12" y1="5" x2="12" y2="19"/><line x1="16" y1="15" x2="12" y2="19"/><line x1="8" y1="15" x2="12" y2="19"/></svg>',setHTML("memory-sort-arrow",t)},orderPapers=(e,t)=>{let a=e[global.state.sortKey],o=t[global.state.sortKey];return void 0===a&&(a=""),void 0===o&&(o=""),"string"==typeof a&&(a=a.toLowerCase(),o=o.toLowerCase()),0<=global.descendingSortKeys.indexOf(global.state.sortKey)?a>o?-1:1:a>o?1:-1},sortMemory=()=>{global.state.sortedPapers=Object.values(cleanPapers(global.state.papers)),global.state.sortedPapers.sort(orderPapers),global.state.papersList.sort(orderPapers)},reverseMemory=()=>{global.state.sortedPapers.reverse(),global.state.papersList.reverse()},filterMemoryByString=e=>{const t=e.toLowerCase().split(" ");let a=[];for(const o of global.state.sortedPapers){const s=o.title.toLowerCase(),r=o.author.toLowerCase(),i=o.note.toLowerCase(),l=getDisplayId(o.id).toLowerCase();t.every(e=>s.includes(e)||r.includes(e)||i.includes(e)||l.includes(e))&&(global.state.showFavorites&&!o.favorite||a.push(o))}global.state.papersList=a},filterMemoryByTags=e=>{const t=e.replace("t:","").toLowerCase().split(" ");let a=[];for(const o of global.state.sortedPapers){const s=o.tags.map(e=>e.toLowerCase());t.every(t=>s.some(e=>0<=e.indexOf(t)))&&(global.state.showFavorites&&!o.favorite||a.push(o))}global.state.papersList=a},filterMemoryByCode=e=>{const a=e.replace("c:","").toLowerCase().split(" ");let o=[];for(const s of global.state.sortedPapers){let t=s.codeLink||"";t=t.toLowerCase(),a.every(e=>t.includes(e))&&(global.state.showFavorites&&!s.favorite||o.push(s))}global.state.papersList=o},updatePaperTagsHTML=e=>{setHTML(findEl(e,"tag-list"),global.state.papers[e].tags.map(e=>`<span class="memory-tag">${e}</span>`).join(""))},updateTagOptions=e=>{updateAllMemoryPaperTagOptions();var t=getTagsOptions(global.state.papers[e]);setHTML("popup-item-tags--"+e,t)},updatePaperTags=(t,e)=>{let a;a=e.startsWith("#")?findEl(e.replace("#","")):findEl(t,e);e=parseTags(a);updated=!1;new Set;arraysIdentical(global.state.papers[t].tags,e)||(updated=!0),global.state.papers[t].tags=e,updated&&chrome.storage.local.set({papers:global.state.papers},()=>{makeTags(),updateTagOptions(t),updatePaperTagsHTML(t);for(const e of Array.from(findEl(t,"tag-list").querySelectorAll(".memory-tag")))addListener(e,"click",handleTagClick)})},makeTags=()=>{let e=new Set;for(const t of global.state.sortedPapers)for(const a of t.tags)e.add(a);global.state.paperTags=Array.from(e),global.state.paperTags.sort()},displayMemoryTable=()=>{var e=Date.now(),t=findEl("memory-table");setHTML(t,"");let a=[];for(const o of global.state.papersList)try{a.push(getMemoryItemHTML(o))}catch(e){log("displayMemoryTable error:"),log(e),log(o)}setHTML(t,a.join("")),addEventToClass(".back-to-focus","click",handleBackToFocus),addEventToClass(".memory-delete","click",handleDeleteItem),addEventToClass(".memory-item-link","click",handleOpenItemLink),addEventToClass(".memory-code-link","click",handleOpenItemCodeLink),addEventToClass(".memory-item-md","click",handleCopyMarkdownLink),addEventToClass(".memory-item-bibtex","click",handleCopyBibtex),addEventToClass(".memory-item-copy-link","click",handleCopyPDFLink),addEventToClass(".memory-item-favorite","click",handleAddItemToFavorites),addEventToClass(".cancel-note-form","click",handleCancelPaperEdit),addEventToClass(".memory-item-edit","click",handleTogglePaperEdit),addEventToClass(".memory-tag","click",handleTagClick),setFormChangeListener(void 0,!1),addEventToClass(".form-note-textarea","focus",handleTextareaFocus);t=Date.now();log("[displayMemoryTable] Display duration (s): "+(t-e)/1e3)},makeMemoryHTML=async()=>{var e=Date.now()/1e3;setPlaceholder("memory-search",`Search ${global.state.papersList.length} entries ...`),displayMemoryTable();let t=300;global.state.papersList.length<20?t=0:global.state.papersList.length<100&&(t=150);Date.now();addListener("memory-search","keypress",delay(handleMemorySearchKeyPress(),t)),addListener("memory-search","clear-search",handleMemorySearchKeyPress(!0)),addListener("memory-search","keyup",handleMemorySearchKeyUp),addListener("cancel-modal-button","click",handleCancelModalClick),addListener("confirm-modal-button","click",handleConfirmDeleteModalClick),addListener("filter-favorites","click",handleFilterFavorites),addListener("memory-select","change",handleMemorySelectChange),addListener("memory-sort-arrow","click",handleMemorySortArrow);var a=Date.now()/1e3;log("Total time to make the memory HTML (async) (s):"+(a-e))},openMemory=()=>{global.state.menuIsOpen&&closeMenu(),global.state.memoryIsOpen=!0,hideId("memory-switch-open"),showId("memory-switch-close"),hideId("menu-switch"),dispatch("memory-switch","blur"),slideDown("memory-container",200,()=>{setTimeout(()=>{dispatch("memory-search","focus")},100)}),setTimeout(()=>{addListener("memory-search-clear-icon","click",handleClearSearch),val("memory-select","lastOpenDate"),setMemorySortArrow("down")},200)},closeMemory=()=>{dispatch("memory-switch","blur"),hideId("memory-switch-close"),showId("memory-switch-open"),slideUp("memory-container",200,()=>{val("memory-search",""),dispatch("memory-search","clear-search"),global.state.memoryIsOpen=!1,global.state.showFavorites&&dispatch("filter-favorites","click"),showId("menu-switch","flex")})},closeMenu=()=>{slideUp("menu-container",300),setHTML("menu-switch",tablerSvg("settings","menu-switch-svg",["tabler-icon","menu-svg"])),dispatch("menu-switch","blur"),global.state.menuIsOpen=!1},openMenu=()=>{slideDown("menu-container",300),dispatch("menu-switch","blur"),setHTML("menu-switch",tablerSvg("circle-x","close-menu-btn",["tabler-icon","menu-svg"])),global.state.menuIsOpen=!0},getAndTrackPopupMenuChecks=(e,t)=>{let a={};for(const o of t){a[o]=e.hasOwnProperty(o)?e[o]:!(0<=global.menuCheckDefaultFalse.indexOf(o));const s=findEl(o);s&&(s.checked=a[o])}chrome.storage.local.set(a);for(const r of t)addListener(r,"change",handleMenuCheckChange)},setStandardPopupClicks=()=>{addListener("helpGithubLink","click",()=>{chrome.tabs.create({url:"https://github.com/vict0rsch/PaperMemory"})}),addListener("whats-new-container","click",()=>{hideId("modal-keyboard-content"),showId("modal-whatsnew-content","contents"),chrome.storage.local.get("whatsnew",({whatsnew:e})=>{var t=chrome.runtime.getManifest().version;(e=void 0===e?{}:e).hasOwnProperty(t)||hideId("whats-new-marker"),chrome.storage.local.set({whatsnew:{...e,[t]:!0}}),style("user-guide-modal","display","flex")})}),addListener("keyboardShortcuts","click",()=>{hideId("modal-whatsnew-content"),showId("modal-keyboard-content","contents"),style("user-guide-modal","display","flex")}),addListener("keyboardShortcutsMenu","click",()=>{hideId("modal-whatsnew-content"),showId("modal-keyboard-content","contents"),style("user-guide-modal","display","flex")}),addListener("close-user-guide-modal","click",()=>{style("user-guide-modal","display","none")}),addListener(window,"click",e=>{e.target===findEl("user-guide-modal")&&style("user-guide-modal","display","none")}),addListener("menu-switch","click",()=>{(global.state.menuIsOpen?closeMenu:openMenu)()}),addListener("memory-switch","click",handleMemorySwitchClick)},popupMain=async(a,e,t=!1)=>{addListener(document,"keydown",handlePopupKeydown),chrome.storage.local.get("whatsnew",({whatsnew:e})=>{var t=chrome.runtime.getManifest().version;e&&e.hasOwnProperty(t)||showId("whats-new-marker")}),t?(hideId("memory-switch"),showId("memory-spinner"),await initState(),hideId("memory-spinner"),showId("memory-switch"),makeMemoryHTML()):setStandardPopupClicks();t=await getStorage(global.menuStorageKeys);if(getAndTrackPopupMenuChecks(t,global.menuCheckNames),addListener("advanced-configuration","click",()=>{chrome.runtime.openOptionsPage()}),e){setTimeout(()=>{document.body.style.height="auto",document.body.style.minHeight="450px"},0),showId("isArxiv","flex");const o=parseIdFromUrl(a);if(!(global.state.currentId=o)||!global.state.papers.hasOwnProperty(o))return log("Unknown id "+o),updatePopupPaperNoMemory(a),void(t.checkDirectOpen&&dispatchEvent("memory-switch","click"));const s=global.state.papers[o];e=s.id.replaceAll(".","\\.");setTextId("popup-paper-title",s.title.replaceAll("\n","")),setTextId("popup-authors",s.author.replaceAll(" and ",", ")),s.codeLink&&(showId("popup-code-link"),setTextId("popup-code-link",s.codeLink.replace(/^https?:\/\//,""))),log(s),setHTML("popup-memory-edit",getPopupEditFormHTML(s)),setHTML("popup-copy-icons",getPopupPaperIconsHTML(s,a)),findEl("checkFavorite--"+o).checked=s.favorite,$("#popup-item-tags--"+e).select2({...global.select2Options,width:"87%"}),addListener("popup-form-note-textarea--"+o,"focus",()=>{textareaFocusEnd(this)}),setFormChangeListener(o,!0),addListener("popup-delete-paper","click",handlePopupDeletePaper(o)),addListener("popup-memory-item-scirate--"+o,"click",()=>{var e=s.id.split("-").reverse()[0];chrome.tabs.update({url:"https://scirate.com/arxiv/"+e}),window.close()}),addListener("popup-memory-item-link--"+o,"click",()=>{var e=paperToPDF(s),t=paperToAbs(s);chrome.tabs.update({url:t===a?e:t}),window.close()}),addListener("popup-code-link","click",()=>{var e=findEl("popup-code-link").textContent;e&&focusExistingOrCreateNewCodeTab(e)}),addListener("popup-memory-item-copy-link--"+o,"click",()=>{var e=global.state.papers[o].pdfLink;copyAndConfirmMemoryItem(o,e,"Pdf link copied!",!0)}),addListener("popup-memory-item-md--"+o,"click",()=>{var e=global.state.papers[o].md;copyAndConfirmMemoryItem(o,e,"MarkDown link copied!",!0)}),addListener("popup-memory-item-bibtex--"+o,"click",()=>{var e=formatBibtext(global.state.papers[o].bibtex);copyAndConfirmMemoryItem(o,e,"Bibtex citation copied!",!0)}),addListener("popup-memory-item-download--"+o,"click",()=>{let e=stateTitleFunction(s);global.state.menu.checkStore&&(e="PaperMemoryStore/"+e,chrome.downloads.search({filenameRegex:"PaperMemoryStore/.*"},e=>{0===(e=e.filter(e=>e.exists)).length&&chrome.downloads.download({url:URL.createObjectURL(new Blob([global.storeReadme])),filename:"PaperMemoryStore/IMPORTANT_README.txt",saveAs:!1})})),log({title:e}),e.endsWith(".pdf")||(e+=".pdf"),e=e.replaceAll(":"," "),chrome.downloads.download({url:s.pdfLink,filename:e})})}else t.checkDirectOpen&&dispatch("memory-switch","click")},query={active:!0,lastFocusedWindow:!0};chrome.tabs.query(query,async e=>{var t=e[0].url;await initState();e=isPaper(t),e=Object.values(e).some(e=>e);e||showId("notArxiv"),hideId("memory-spinner"),showId("memory-switch"),makeMemoryHTML(),popupMain(t,e),-1<navigator.userAgent.search("Firefox")&&hideId("overwrite-container")});